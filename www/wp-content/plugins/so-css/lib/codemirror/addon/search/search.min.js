!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}((function(e){"use strict";function n(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function o(e){return e.state.search||(e.state.search=new n)}function t(e){return"string"==typeof e&&e==e.toLowerCase()}function r(e,n,o){return e.getSearchCursor(n,o,{caseFold:t(n),multiline:!0})}function i(e,n,o,t,r){e.openDialog?e.openDialog(n,r,{value:t,selectValueOnOpen:!0}):r(prompt(o,t))}function a(e){return e.replace(/\\(.)/g,(function(e,n){return"n"==n?"\n":"r"==n?"\r":n}))}function s(e){var n=e.match(/^\/(.*)\/([a-z]*)$/);if(n)try{e=new RegExp(n[1],-1==n[2].indexOf("i")?"":"i")}catch(e){}else e=a(e);return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}var c='<span class="CodeMirror-search-label">Search:</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';function l(e,n,o){n.queryText=o,n.query=s(o),e.removeOverlay(n.overlay,t(n.query)),n.overlay=function(e,n){return"string"==typeof e?e=new RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n?"gi":"g"):e.global||(e=new RegExp(e.source,e.ignoreCase?"gi":"g")),{token:function(n){e.lastIndex=n.pos;var o=e.exec(n.string);if(o&&o.index==n.pos)return n.pos+=o[0].length||1,"searching";o?n.pos=o.index:n.skipToEnd()}}}(n.query,t(n.query)),e.addOverlay(n.overlay),e.showMatchesOnScrollbar&&(n.annotate&&(n.annotate.clear(),n.annotate=null),n.annotate=e.showMatchesOnScrollbar(n.query,t(n.query)))}function u(n,t,r,a){var s=o(n);if(s.query)return f(n,t);var u=n.getSelection()||s.lastQuery;if(u instanceof RegExp&&"x^"==u.source&&(u=null),r&&n.openDialog){var d=null,y=function(o,t){e.e_stop(t),o&&(o!=s.queryText&&(l(n,s,o),s.posFrom=s.posTo=n.getCursor()),d&&(d.style.opacity=1),f(n,t.shiftKey,(function(e,o){var t;o.line<3&&document.querySelector&&(t=n.display.wrapper.querySelector(".CodeMirror-dialog"))&&t.getBoundingClientRect().bottom-4>n.cursorCoords(o,"window").top&&((d=t).style.opacity=.4)})))};!function(e,n,o,t,r){e.openDialog(n,t,{value:o,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){p(e)},onKeyDown:r})}(n,c,u,y,(function(t,r){var i=e.keyName(t),a=n.getOption("extraKeys"),s=a&&a[i]||e.keyMap[n.getOption("keyMap")][i];"findNext"==s||"findPrev"==s||"findPersistentNext"==s||"findPersistentPrev"==s?(e.e_stop(t),l(n,o(n),r),n.execCommand(s)):"find"!=s&&"findPersistent"!=s||(e.e_stop(t),y(r,t))})),a&&u&&(l(n,s,u),f(n,t))}else i(n,c,"Search for:",u,(function(e){e&&!s.query&&n.operation((function(){l(n,s,e),s.posFrom=s.posTo=n.getCursor(),f(n,t)}))}))}function f(n,t,i){n.operation((function(){var a=o(n),s=r(n,a.query,t?a.posFrom:a.posTo);(s.find(t)||(s=r(n,a.query,t?e.Pos(n.lastLine()):e.Pos(n.firstLine(),0))).find(t))&&(n.setSelection(s.from(),s.to()),n.scrollIntoView({from:s.from(),to:s.to()},20),a.posFrom=s.from(),a.posTo=s.to(),i&&i(s.from(),s.to()))}))}function p(e){e.operation((function(){var n=o(e);n.lastQuery=n.query,n.query&&(n.query=n.queryText=null,e.removeOverlay(n.overlay),n.annotate&&(n.annotate.clear(),n.annotate=null))}))}function d(e,n,o){e.operation((function(){for(var t=r(e,n);t.findNext();)if("string"!=typeof n){var i=e.getRange(t.from(),t.to()).match(n);t.replace(o.replace(/\$(\d)/g,(function(e,n){return i[n]})))}else t.replace(o)}))}function y(e,n){if(!e.getOption("readOnly")){var t=e.getSelection()||o(e).lastQuery,c='<span class="CodeMirror-search-label">'+(n?"Replace all:":"Replace:")+"</span>";i(e,c+' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',c,t,(function(o){o&&(o=s(o),i(e,'<span class="CodeMirror-search-label">With:</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',"Replace with:","",(function(t){if(t=a(t),n)d(e,o,t);else{p(e);var i=r(e,o,e.getCursor("from")),s=function(){var n,a=i.from();!(n=i.findNext())&&(i=r(e,o),!(n=i.findNext())||a&&i.from().line==a.line&&i.from().ch==a.ch)||(e.setSelection(i.from(),i.to()),e.scrollIntoView({from:i.from(),to:i.to()}),function(e,n,o,t){e.openConfirm?e.openConfirm(n,t):confirm(o)&&t[0]()}(e,'<span class="CodeMirror-search-label">Replace?</span> <button>Yes</button> <button>No</button> <button>All</button> <button>Stop</button>',"Replace?",[function(){c(n)},s,function(){d(e,o,t)}]))},c=function(e){i.replace("string"==typeof o?t:t.replace(/\$(\d)/g,(function(n,o){return e[o]}))),s()};s()}})))}))}}e.commands.find=function(e){p(e),u(e)},e.commands.findPersistent=function(e){p(e),u(e,!1,!0)},e.commands.findPersistentNext=function(e){u(e,!1,!0,!0)},e.commands.findPersistentPrev=function(e){u(e,!0,!0,!0)},e.commands.findNext=u,e.commands.findPrev=function(e){u(e,!0)},e.commands.clearSearch=p,e.commands.replace=y,e.commands.replaceAll=function(e){y(e,!0)}}));